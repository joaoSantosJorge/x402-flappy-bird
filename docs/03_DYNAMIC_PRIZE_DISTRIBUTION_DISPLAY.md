# 03 - Dynamic Prize Pool Distribution Display

## Overview

This feature updates the Prize Pool Distribution section in `rules.html` to display the actual current configuration (number of winners, percentage for each winner, admin fee) that updates automatically when the admin changes values.

## Problem

Previously, the rules.html page displayed static, hardcoded values for the prize distribution (5 winners with fixed percentages). When the admin changed the number of winners or fee percentage, the rules page would show incorrect information.

## Solution

Created a new `WinnerAllocationManager` module in `config.js` that:
1. Fetches the current configuration from Firebase
2. Dynamically generates the allocation table and example calculations
3. Supports cross-tab synchronization via localStorage
4. Auto-updates when admin changes values

## Files Modified

1. **`frontend/js/config.js`** - Added `WinnerAllocationManager` module
2. **`frontend/rules.html`** - Replaced static table with dynamic containers
3. **`frontend/admin.html`** - Added calls to broadcast config changes

## Implementation Details

### WinnerAllocationManager (config.js)

Key functions:
- `calculatePercentages(numWinners, feePercentage)` - Calculates allocation based on predefined ratios (copied from `cycleManager.js`)
- `updateDisplayElements()` - Generates dynamic HTML for allocation table and example box
- `fetchFromFirebase()` - Fetches config from `config/settings` document
- Cross-tab sync via `localStorage` events

Predefined allocation ratios:
| Winners | Distribution |
|---------|-------------|
| 1 | 100% |
| 2 | 70%, 30% |
| 3 | 60%, 30%, 10% |
| 4 | 60%, 25%, 10%, 5% |
| 5 | 50%, 25%, 15%, 7%, 3% |
| 6 | 40%, 25%, 15%, 10%, 6%, 4% |
| 7 | 35%, 25%, 15%, 10%, 8%, 4%, 3% |
| 8 | 30%, 25%, 15%, 10%, 10%, 5%, 3%, 2% |
| 9 | 28%, 25%, 15%, 10%, 10%, 6%, 3%, 2%, 1% |
| 10 | 25%, 20%, 15%, 10%, 10%, 7%, 5%, 4%, 3%, 1% |

### rules.html Changes

Replaced static table (lines 354-393) with:
```html
<div id="allocation-table-container">
    <!-- Dynamically generated by WinnerAllocationManager -->
</div>
```

Replaced static example (lines 396-407) with:
```html
<div id="example-calculation-container">
    <!-- Dynamically generated by WinnerAllocationManager -->
</div>
```

### admin.html Changes

Added broadcasts after successful config updates:
```javascript
// After updating number of winners
WinnerAllocationManager.setNumberOfWinners(parseInt(winners));

// After updating fee percentage
WinnerAllocationManager.setFeePercentage(parseInt(fee));
```

## Usage

The feature works automatically:
1. When `rules.html` loads, it fetches current config from Firebase
2. Displays the current allocation table and example calculations
3. When admin updates config in `admin.html`, changes are broadcast via localStorage
4. Other tabs (including `rules.html`) receive updates and refresh their display

## API

```javascript
// Get current number of winners
WinnerAllocationManager.getNumberOfWinners(); // Returns number (1-10)

// Get fee percentage in basis points
WinnerAllocationManager.getFeePercentage(); // Returns number (e.g., 1000 = 10%)

// Get fee as display string
WinnerAllocationManager.getFeePercentageDisplay(); // Returns string (e.g., "10")

// Get allocation percentages array
WinnerAllocationManager.getAllocationPercentages(); // Returns array of basis points

// Set values (used by admin.html)
WinnerAllocationManager.setNumberOfWinners(winners);
WinnerAllocationManager.setFeePercentage(fee);

// Subscribe to changes
WinnerAllocationManager.onUpdate((winners, fee) => { ... });

// Force refresh from Firebase
WinnerAllocationManager.refresh();
```

## Testing

1. **Default display**: Open rules.html - verify table shows current Firebase config
2. **Admin update**: Change winners/fee in admin.html, refresh rules.html - verify updates
3. **Cross-tab sync**: Open rules.html in one tab, change config in another - verify sync
4. **Mobile view**: Verify table displays correctly on mobile devices
